# Deploy to server on push to master or manual run.
#
# In GitHub: Settings → Secrets and variables → Actions, add:
#   DEPLOY_SSH_KEY  — private key (e.g. contents of opencloud.pem)
#   SERVER_HOST     — e.g. 94.158.57.56
#   SERVER_USER     — e.g. ubuntu
#   SERVER_REPO_DIR — (optional) path on server, default ~/netowrk-academy

name: Deploy

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            cd ${{ secrets.SERVER_REPO_DIR || '~/netowrk-academy' }}
            git fetch origin
            git reset --hard origin/master
            cd docker
            docker compose -f compose.prod.yaml build --no-cache app
            docker compose -f compose.prod.yaml up -d
            docker image prune -f
